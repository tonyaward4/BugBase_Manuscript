#### Complete BugBase manuscript analysis ###
# Requirements:
# - BugBase and R,required R packages installed
# - full data directory from Git BugBase manuscript repository


#### Data Files ####
# HMP OTU table was generated using QIIME v.1.8.0 (closed reference) 
# with the GreenGenes 97% representative set v.13.5.8 and was filtered to keep
# only samples with at least 500 counts and samples from the tongue dorsum, stool and plaque
# Ref: Human Microbiome Project Consortium. Structure, function and diversity of the healthy human microbiome. Nature 486, 207–214 (2012).
# Files:
# HMP_Map.txt
# HMP_OTUS.biom

# The OTU table for the western, non-western stool analysis was pulled from the Qitta website
# and was filtered to keep samples from only non-infants (>3 years of age) and samples with a 
# minimum of 500 sequence counts
# Ref: Yatsunenko, T. et al. Human gut microbiome viewed across age and geography. Nature 486, 222–227 (2012).
# Files:
# Yats_Adult_Map.txt
# Yats_Adult_OTUs.biom

# The OTU table for the Yellow Stone hotspring analysis was pulled from the Qitta website
# and was filtered to keep only water samples and samples with a minimum of 500 sequence counts
# Ref: This data is not published elsewhere (yet!)
# Files:
# Yellow_Stone_Map.txt
# Yellow_Stone_OTUs.biom

# The OTU table for the soil analysis was pulled from the Qitta website
# and was filtered to keep samples with a minimum of 500 sequence counts
# Ref: 	Bartram, A. K. et al. Exploring links between pH and bacterial community composition in soils from the Craibstone Experimental Farm. FEMS Microbiol. Ecol. 87, 403–415 (2014).
# Files:
# Soil_Map.txt
# Soil_OTUs.biom

# The vagina OTU table was generated using NINJA-OPS (closed reference)
# with the GreenGenes 97% representative set v13.5.8 all samples had a minimum of 300 sequences
# Ref: Ravel, J. et al. Vaginal microbiome of reproductive-age women. Proc. Natl. Acad. Sci. 108, 4680–4687 (2011).
# Files:
# Vagina_Map.txt
# Vagina_OTUs.biom

#### Run BugBase analysis ####

run.bugbase.r -i data/HMP_OTUs.biom -m HMP_Map.txt -c HMPBODYSUBSITE -o BB_HMP
run.bugbase.r -i data/Yats_Adult_OTUs.biom -m data/Yats_Adult_Map.txt -c COUNTRY -o BB_Yats
run.bugbase.r -i data/Yellow_Stone_OTUs.biom -m data/Yellow_Stone_Map.txt -c temp -o BB_Yellow -z
run.bugbase.r -i data/Soil_OTUs.biom -m data/Soil_Map.txt -c ph -o BB_Soil -z
run.bugbase.r -i data/Vagina_OTUs.biom -m data/Vagina_Map.txt -c Nugent_score_categoryb -o BB_Vagina

#### Make Figure 2  plots ####
source("bin/Figure_2.r")

#### Make Figure 3 & Supplemental Figure X ####

#Create custom trait tables for pathways of interest
make.user.table.r -i data/custom_pathways

#Run BugBase predicitons with these tables
run.bugbase.r -u data/custom_pathways/Custom_BugBase_Traits.txt -i data/HMP_OTUs.biom -m data/HMP_Map.txt -c HMPBODYSUBSITE -o Fig_3_Pathways

#Make BugBase predictions for all Kegg level 3 modules
#This take about 1.5 hours
run.bugbase.r -i data/HMP_OTUs.biom -k -x -o BB_HMP_Kegg

#Analyze and plot
source("bin/Figure_3_pathways.r")
source("bin/Figure_3_Kegg1.r")
source("bin/Figure_3_Kegg2.r")



